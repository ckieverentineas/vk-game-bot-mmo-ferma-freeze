import { User } from "@prisma/client";
import { answerTimeLimit, chat_id, timer_text } from "../../../";
import prisma from "../../prisma";
import { Context, Keyboard } from "vk-io";
import { User_Menu_Show } from "./control";
import { Send_Message_Universal } from "../../../module/fab/helper";

export async function User_Register(context: Context) {
    //—Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É
	const answer = await context.question(`üïµÔ∏è‚Äç‚ôÇÔ∏è –ö–∞–∫ —Ç–æ–ª—å–∫–æ —Ç—ã –≤–≤–∞–ª–∏–ª—Å—è –≤ –æ—Ñ–∏—Å üè¶, –ø–µ—Ä–µ–¥ —Ç–æ–±–æ–π, –∫–∞–∫ –∏–∑ –Ω–∏–æ—Ç–∫—É–¥–∞, –≤—ã—Å–∫–æ—á–∏–ª–∏ –¥–≤–æ–µ –≤ —á–µ—Ä–Ω—ã—Ö –æ—á–∫–∞—Ö –∏ —Å —É—Ö–º—ã–ª–∫–∞–º–∏ –Ω–∞ –ª–∏—Ü–∞—Ö –ø—Ä–æ–∏–∑–Ω–µ—Å–ª–∏:\n\n‚Äî –£ –Ω–∞—Å –ø–ª–æ—Ö–∏–µ –Ω–æ–≤–æ—Å—Ç–∏, –º–∞–ª–µ—Ü: —Ç–≤–æ–π –æ—Ç–µ—Ü –Ω–µ —Å –Ω–∞–º–∏. –¢—ã –∑–¥–µ—Å—å –≤–ø–µ—Ä–≤—ã–µ, —Ç–∞–∫ —á—Ç–æ —Å–Ω–∞—á–∞–ª–∞ –ø–æ–¥–ø–∏—à–∏, —á—Ç–æ —Å–æ–≥–ª–∞—Å–µ–Ω –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–≤–æ–∏—Ö –¥–∞–Ω–Ω—ã—Ö.\n\n–í —Ç–æ—Ç –∂–µ –º–∏–≥ –≤ –∏—Ö —Ä—É–∫–∞—Ö –±–ª–µ—Å–Ω—É–ª–∏ –ø–µ—Ä–≥–∞–º–µ–Ω—Ç –∏ –∞–≤—Ç–æ–º–∞—Ç—ã –ê–ö-47.\n\nüí° –£—á—Ç–∏, –Ω–∞ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã —É –Ω–∞—Å –≤—Å–µ–≥–æ 5 –º–∏–Ω—É—Ç, —Ç–∞–∫ —á—Ç–æ –Ω–µ —Ç—Ä–∞—Ç—å –≤—Ä–µ–º—è –∑—Ä—è!`,
        {	
            keyboard: Keyboard.builder()
            .textButton({ label: '‚úè', payload: { command: '–°–æ–≥–ª–∞—Å–∏—Ç—å—Å—è' }, color: 'positive' }).row()
            .textButton({ label: 'üë£', payload: { command: '–û—Ç–∫–∞–∑–∞—Ç—å—Å—è' }, color: 'negative' }).oneTime(),
            answerTimeLimit
        }
    );
    if (answer.isTimeout) { return await context.send(`‚è∞ –í—Ä–µ–º—è –≤—ã—à–ª–æ, –º–∞–ª–µ—Ü! –¢—ã –Ω–µ —É—Å–ø–µ–ª –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–æ–≥–ª–∞—Å–∏–µ, –∏ —Ç–µ–ø–µ—Ä—å —Ç—ã —Ç–æ–∂–µ –≤ –Ω–∞—à–µ–º —Å–ø–∏—Å–∫–µ. –ü–æ—Ä–∞ –ø—Ä–æ—â–∞—Ç—å—Å—è!`); }
    if (!/–¥–∞|yes|–°–æ–≥–ª–∞—Å–∏—Ç—å—Å—è|–∫–æ–Ω–µ—á–Ω–æ|‚úè/i.test(answer.text|| '{}')) {
        await context.send('üö´ –¢—ã –æ—Ç–∫–∞–∑–∞–ª—Å—è –¥–∞—Ç—å —Å–æ–≥–ª–∞—Å–∏–µ, –∞ –∑–Ω–∞–µ—à—å, –∫–∞–∫ —É –Ω–∞—Å —Å —ç—Ç–∏–º –æ–±—Å—Ç–æ—è—Ç –¥–µ–ª–∞? –ñ–∏–≤—ã–º –æ—Ç—Å—é–¥–∞ –Ω–∏–∫—Ç–æ –Ω–µ —É—Ö–æ–¥–∏—Ç ‚Äî —Ç–µ–±—è —É–ø–∞–∫–æ–≤–∞–ª–∏, –º–∞–ª–µ—Ü!');
        return;
    }
    //–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏–≥—Ä–æ–∫–∞
    const visit = await context.question(`‚åõ –ü–æ—Å—Ç–∞–≤–∏–≤ —Å–≤–æ—é –ø–æ–¥–ø–∏—Å—å, —Ç—ã —Å—Ç–∞—Ä–∞–ª—Å—è –Ω–µ –≤—Å—Ç—Ä–µ—á–∞—Ç—å—Å—è –≤–∑–≥–ª—è–¥–∞–º–∏ —Å –∫—Ä—É—Ç—ã–º–∏ –ø–∞—Ä–Ω—è–º–∏ –≤ —á–µ—Ä–Ω—ã—Ö –æ—á–∫–∞—Ö. –°–µ–ª –≤ —Å–≤–æ–µ –Ω–æ–≤–æ–µ –∫—Ä–µ—Å–ª–æ –±–æ—Å—Å–∞ –∏ –∑–∞–ø—É—Å—Ç–∏–ª –∫–æ–º–ø—å—é—Ç–µ—Ä –≤ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–º –¥–æ–º–µ–Ω–µ, –≥–æ—Ç–æ–≤—è—Å—å –∫ —Ç–æ–º—É, —á—Ç–æ –∂–¥–µ—Ç –≤–ø–µ—Ä–µ–¥–∏.`,
        { 	
            keyboard: Keyboard.builder()
            .textButton({ label: '–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞—Ç–∞–∫—É', payload: { command: '–°–æ–≥–ª–∞—Å–∏—Ç—å—Å—è' }, color: 'positive' }).row()
            .textButton({ label: '–°–º–æ—Ç—Ä–µ—Ç—å –≤ –±–µ–∑–¥–Ω—É', payload: { command: '–û—Ç–∫–∞–∑–∞—Ç—å—Å—è' }, color: 'negative' }).oneTime().inline(),
            answerTimeLimit
        }
    );
    if (visit.isTimeout) { return await context.send(`‚è∞ –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏—Å—Ç–µ–∫–ª–æ!`) }
    let name = null
    while (!name) {
        const name_in = await context.question( `üß∑ –ß–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è —Ç—ã –≤–∫–∞—Ç–∏–ª—Å—è –≤ —Å–∏—Å—Ç–µ–º—É –ø–æ–¥ —Å–≤–æ–µ–π —É—á–µ—Ç–∫–æ–π üè¶! –ü–æ—Ö–æ–∂–µ, —Ç—ã –∑–¥–µ—Å—å –Ω–æ–≤–µ–Ω—å–∫–∏–π. –ù–∞–∑–æ–≤–∏ —Å–≤–æ–π –Ω–∏–∫–Ω–µ–π–º, –º–∞–ª–µ—Ü.\n‚ùó –£—á—Ç–∏! –õ–æ–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ‚Äî —ç—Ç–æ —Å–µ—Ä—å–µ–∑–Ω–æ–µ –¥–µ–ª–æ, –∏ –∑–∞ —ç—Ç–æ –º–æ–≥—É—Ç –Ω–∞—Å—Ç—É—á–∞—Ç—å –ø–æ —à–∞–ø–∫–µ!`, timer_text)
        if (name_in.isTimeout) { return await context.send(`‚è∞ –í—Ä–µ–º—è –≤—ã—à–ª–æ, –º–∞–ª–µ—Ü! –¢—ã –Ω–µ —É—Å–ø–µ–ª –≤–≤–µ—Å—Ç–∏ –∏–º—è, –∏ —Ç–µ–ø–µ—Ä—å —É –Ω–∞—Å –¥–ª—è —Ç–µ–±—è –ø–ª–æ—Ö–∏–µ –Ω–æ–≤–æ—Å—Ç–∏!`) }
        if (name_in.text.length <= 64) {
            name = name_in.text
            if (name_in.text.length > 32) { await context.send(`‚ö† –¢–≤–æ–∏ –§–ò–û –Ω–µ –≤–ª–µ–∑–∞—é—Ç –≤ –±–ª–∞–Ω–∫ (32 —Å–∏–º–≤–æ–ª–∞)! –ú–æ–∂–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –±–ª–∞–Ω–∫, –Ω–æ –∑–∞ –∫–∞–∂–¥—ã–π –ª–∏—à–Ω–∏–π —Å–∏–º–≤–æ–ª –ø—Ä–∏–¥–µ—Ç—Å—è –æ—Ç–¥–∞—Ç—å 1‚Ç™.`) }
        } else { await context.send(`‚õî –¢–≤–æ–∏ –§–ò–û –Ω–µ –≤–ª–µ–∑–∞—é—Ç –≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –±–ª–∞–Ω–∫ (64 —Å–∏–º–≤–æ–ª–∞), –∏ –≤–æ–æ–±—â–µ, —ç—Ç–æ –ø–æ–¥ –∑–∞–ø—Ä–µ—Ç–æ–º –ø–æ –∑–∞–∫–æ–Ω—É! –í—ã–ø–ª–∞—Ç–∏ —à—Ç—Ä–∞—Ñ –≤ 30‚Ç™, –∏–ª–∏ –ª—é–¥–∏ –≤ —á–µ—Ä–Ω–æ–º –±—ã—Å—Ç—Ä–æ —Ä–∞–∑–±–µ—Ä—É—Ç—Å—è —Å —Ç–æ–±–æ–π.`) }
    }
    const save: User = await prisma.user.create({	data: {	idvk: context.senderId, name } })
    if (save) {
        await context.send(`‚åõ –ö–æ—Ä–ø–æ—Ä–∞—Ü–∏—è –∑–ª–∞ ${save.name} —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–∞. \n ‚öñ –£ —Ç–µ–±—è —Ç–µ–ø–µ—Ä—å —Å—á–µ—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—è —Å UID: ${save.id}. \n üè¶ –ù–∞ —Å—á–µ—Ç –∑–∞—á–∏—Å–ª–µ–Ω–æ ${save.gold} —à–µ–∫–µ–ª–µ–π. –ì–æ—Ç–æ–≤—å—Å—è –∫ –¥–µ–ª—É!`);
        console.log(`Success save user idvk: ${context.senderId}`)
    }
    await context.send(`üí° –ö–æ–≥–¥–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –Ω–µ—Ç, –Ω–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É [–∫–ª–∞–≤–∞] –±–µ–∑ –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö —Å–∫–æ–±–æ—á–µ–∫`)
    await context.send(`‚úÖ üí° –î–ª—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Ç–µ–±–µ –Ω—É–∂–Ω–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –í–ö –∏–ª–∏ –∫–æ–º–ø.\n–ê —Ç–µ–ø–µ—Ä—å –∏–¥–∏ –≤ –ø–ª–∞–Ω–µ—Ç—ã –∫–æ–ª–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ—é –ø–µ—Ä–≤—É—é –ø–ª–∞–Ω–µ—Ç—É –∏—Å–ø–æ–ª—å–∑—É–π –±–∞–∑–æ–≤—ã–π –±–∏–ª–¥:\n- –°–∫–ª–∞–¥ x1 (—á—Ç–æ–±—ã —Å–∫–ª–∞–¥–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—Å—É—Ä—Å—ã)\n- –®–∞—Ö—Ç–∞ —Ö1 (—á—Ç–æ–±—ã –∏—Å—Ç–æ—â–∏—Ç—å –≥—Ä–µ–±–∞–Ω–Ω—É—é –ø–ª–∞–Ω–µ—Ç—É –ø–æ–¥ –Ω–æ–ª–∏–∫)\n- –ì–æ—Ä–æ–¥ —Ö1 (—á—Ç–æ–±—ã –æ–±–µ—Å–ø–µ—á–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∂–∏–ª—å–µ–º –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–º–∏ —É–ø—Ä–∞–≤–ª—è—Ç—å)\n- –¶–µ–Ω—Ç—Ä–æ–±–∞–Ω–∫ —Ö1 (—á—Ç–æ–±—ã –¥–æ–±—ã—Ç–æ–µ –∑–æ–ª–æ—Ç–æ —à–∞—Ö—Ç–∞–º–∏, —á–µ–∫–∞–Ω–∏—Ç—å –≤ —à–µ–∫–µ–ª–∏)\n- –≠–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–Ω—Ü–∏—è —Ö1 (—á—Ç–æ–±—ã –¥–æ–±—ã—Ç—ã–π —É–≥–æ–ª—å –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ —ç–Ω–µ—Ä–≥–∏—é –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏—è)\n- –ó–∞–≤–æ–¥ —Ö1 (—á—Ç–æ–±—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –¥–æ–±—ã—Ç—É—é —Ä—É–¥—É —à–∞—Ö—Ç–∞–º–∏ –≤ –∂–µ–ª–µ–∑–Ω—ã–µ —Å–ª–∏—Ç–∫–∏)\n- –ê—Ä—Ö–µ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ü–µ–Ω—Ç—Ä —Ö1 (—á—Ç–æ–±—ã –¥–æ–±—ã—Ç—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –≤—Å–∫—Ä—ã–≤–∞—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –ø–ª–æ—â–∞–¥–æ–∫)\n–ù–∞ —Å—Ç–∞—Ä—Ç–µ –¥–∞–µ—Ç—Å—è –ª–∏—à—å 7 –ø–ª–æ—â–∞–¥–æ–∫\n\n–¢–∞–∫–∂–µ –¥–æ—Å—Ç—É–ø–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ [!–ø–æ–º–æ—â—å], —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–ø–∏—Å–æ–∫ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –∫–æ–º–∞–Ω–¥.`);
    await Send_Message_Universal(chat_id, `‚Åâ@id${save.idvk}(${save.name}) –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–≤–æ–π –±–∏–∑–Ω–µ—Å –ø–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É UID: ${save.id}!`)
    await User_Menu_Show(context, save)
}